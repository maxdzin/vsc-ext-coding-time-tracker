name: Publish Extension to Visual Studio Marketplace

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'  # Ignore changes to workflow files
  workflow_dispatch:  # Allow manual trigger

jobs:
  verify-changes:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check-changes.outputs.should_publish }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all tags and branches
          
      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | tr '\n' ' ')" >> $GITHUB_OUTPUT
          
      - name: Check version change and file types
        id: check-changes
        run: |
          # Check if package.json version changed
          VERSION_CHANGED=$(git diff ${{ github.event.before }} ${{ github.event.after }} package.json | grep '+\s*"version"')
          
          # Get list of changed files
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          
          # Check if only documentation files were changed
          DOCS_ONLY=true
          for file in $CHANGED_FILES; do
            if [[ ! $file =~ \.(md|txt|doc|docx)$ ]] && [[ ! $file =~ ^docs/ ]]; then
              DOCS_ONLY=false
              break
            fi
          done
          
          # Initialize should_publish as false
          echo "should_publish=false" >> $GITHUB_OUTPUT
          
          if [[ "$DOCS_ONLY" == "true" ]]; then
            echo "ℹ️ Only documentation files were changed"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          elif [[ -z "$VERSION_CHANGED" ]]; then
            echo "❌ Version in package.json was not updated"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Version changed and non-documentation files modified"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

  publish:
    needs: verify-changes
    if: needs.verify-changes.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    environment: VSC EXT
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Compile
        run: npm run compile
          - name: Install vsce
        run: npm install -g @vscode/vsce
        
      - name: Clean existing VSIX files
        run: rm -f *.vsix

      - name: Package Extension
        run: vsce package
        
      - name: Get Package Info
        id: package
        run: |
          VERSION=$(node -p "require('./package.json').version")
          VSIX_PATH="simple-coding-time-tracker-${VERSION}.vsix"
          if [ ! -f "$VSIX_PATH" ]; then
            echo "Error: Expected VSIX file $VSIX_PATH not found"
            exit 1
          fi
          echo "Package created: $VSIX_PATH"
          echo "vsix_path=$VSIX_PATH" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Upload VSIX as artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-release-v${{ steps.package.outputs.version }}-${{ steps.package.outputs.date }}
          path: "*.vsix"
          retention-days: 99  # Maximum retention period allowed by GitHub
          
      - name: Publish to Visual Studio Marketplace
        run: vsce publish -p "${{ secrets.VSC_PAT }}"