name: Publish Extension to Visual Studio Marketplace
on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'  # Ignore changes to workflow files
  workflow_dispatch:  # Allow manual trigger
jobs:
  verify-changes:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check-changes.outputs.should_publish }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all tags and branches
          
      - name: Get changed files
        id: changed-files
        run: |
          # Handle different trigger scenarios
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual triggers, compare with previous commit
            echo "files=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          elif [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # For first commit or when before is null, get all files in the commit
            echo "files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git ls-files | tr '\n' ' ')" >> $GITHUB_OUTPUT
          else
            # Normal push event
            echo "files=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi
          
      - name: Check version change and file types
        id: check-changes
        run: |
          # Check if package.json version changed with proper fallback
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual triggers, check if version changed in last commit
            VERSION_CHANGED=$(git diff HEAD~1 HEAD package.json | grep -E '^\+\s*"version"' || echo "")
          elif [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # For first commit or when before is null, assume version changed
            VERSION_CHANGED="version_changed_first_commit"
          else
            # Normal push event
            VERSION_CHANGED=$(git diff ${{ github.event.before }} ${{ github.event.after }} package.json | grep -E '^\+\s*"version"' || echo "")
          fi
          
          # Get list of changed files
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          
          # Debug output
          echo "üîç Event: ${{ github.event_name }}"
          echo "üìÅ Changed files: $CHANGED_FILES"
          echo "üì¶ Version changed: ${VERSION_CHANGED:-'no'}"
          
          # Check if only documentation files were changed
          DOCS_ONLY=true
          for file in $CHANGED_FILES; do
            if [[ ! $file =~ \.(md|txt|doc|docx)$ ]] && [[ ! $file =~ ^docs/ ]]; then
              DOCS_ONLY=false
              break
            fi
          done
          
          # Initialize should_publish as false
          echo "should_publish=false" >> $GITHUB_OUTPUT
          
          # For manual workflow dispatch, always publish (assuming user knows what they're doing)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üöÄ Manual workflow dispatch - proceeding with publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          elif [[ "$DOCS_ONLY" == "true" ]]; then
            echo "‚ÑπÔ∏è Only documentation files were changed"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          elif [[ -z "$VERSION_CHANGED" ]]; then
            echo "‚ùå Version in package.json was not updated"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Version changed and non-documentation files modified"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi
  publish:
    needs: verify-changes
    if: needs.verify-changes.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    environment: VSC EXT
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Compile
        run: npm run compile
        
      - name: Install vsce
        run: npm install -g @vscode/vsce@latest
        
      - name: Clean existing VSIX files
        run: rm -f *.vsix
      - name: Package Extension
        run: vsce package
        
      - name: Get Package Info
        id: package
        run: |
          VERSION=$(node -p "require('./package.json').version")
          VSIX_PATH="simple-coding-time-tracker-${VERSION}.vsix"
          if [ ! -f "$VSIX_PATH" ]; then
            echo "Error: Expected VSIX file $VSIX_PATH not found"
            exit 1
          fi
          echo "Package created: $VSIX_PATH"
          echo "vsix_path=$VSIX_PATH" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Validate Package
        run: |
          # Verify the package can be listed
          vsce ls ${{ steps.package.outputs.vsix_path }}
          
          # Check package size (warn if > 10MB)
          SIZE=$(stat -c%s "${{ steps.package.outputs.vsix_path }}" 2>/dev/null || stat -f%z "${{ steps.package.outputs.vsix_path }}")
          SIZE_MB=$((SIZE / 1024 / 1024))
          if [ $SIZE_MB -gt 10 ]; then
            echo "‚ö†Ô∏è Warning: Package size is ${SIZE_MB}MB (consider optimizing)"
          else
            echo "‚úÖ Package size: ${SIZE_MB}MB"
          fi
          
      - name: Upload VSIX as artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-release-v${{ steps.package.outputs.version }}-${{ steps.package.outputs.date }}
          path: "*.vsix"
          retention-days: 90  # Maximum retention period allowed by GitHub
          
      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.package.outputs.version }}" >/dev/null 2>&1; then
            echo "Tag v${{ steps.package.outputs.version }} already exists"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to VS Code Marketplace
        id: marketplace_publish
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: vsce publish -p $VSC_PAT --packagePath ${{ steps.package.outputs.vsix_path }}
        env:
          VSC_PAT: ${{ secrets.VSC_PAT }}

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            # Generate changelog from commits since last tag
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
            
            # Create release body with actual changes
            cat << EOF > release_body.md
          ## What's Changed
          
          ${CHANGELOG}
          
          ## Installation
          
          - **VS Code Marketplace**: Search for "Simple Coding Time Tracker" in VS Code Extensions
          - **Manual Install**: Download the \`.vsix\` file below and install via \`Extensions: Install from VSIX\`
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${{ steps.package.outputs.version }}
          EOF
          else
            cat << EOF > release_body.md
          ## What's Changed
          
          Initial release of Simple Coding Time Tracker v${{ steps.package.outputs.version }}
          
          ## Installation
          
          - **VS Code Marketplace**: Search for "Simple Coding Time Tracker" in VS Code Extensions  
          - **Manual Install**: Download the \`.vsix\` file below and install via \`Extensions: Install from VSIX\`
          EOF
          fi

      - name: Create GitHub Release
        id: create_release
        if: steps.check_tag.outputs.tag_exists == 'false' && steps.marketplace_publish.outcome == 'success'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.package.outputs.version }}
          name: Release v${{ steps.package.outputs.version }}
          body_path: release_body.md
          files: ${{ steps.package.outputs.vsix_path }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report Success
        if: steps.create_release.outcome == 'success'
        run: |
          echo "üéâ Release v${{ steps.package.outputs.version }} created successfully!"
          echo "üì¶ VS Code Marketplace: Published"
          echo "üè∑Ô∏è GitHub Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.package.outputs.version }}"

      - name: Handle Failure
        if: failure()
        run: |
          echo "‚ùå Workflow failed. Please check the logs above."
          if [ "${{ steps.marketplace_publish.outcome }}" = "failure" ]; then
            echo "üö® Marketplace publishing failed - check your VSCE_PAT token"
          fi
          if [ "${{ steps.check_tag.outputs.tag_exists }}" = "true" ]; then
            echo "‚ö†Ô∏è Tag v${{ steps.package.outputs.version }} already exists"
          fi
          exit 1

      - name: Notify on Success
        if: success()
        run: |
          echo "::notice title=Release Published::Version v${{ steps.package.outputs.version }} has been published to VS Code Marketplace and GitHub Releases"
