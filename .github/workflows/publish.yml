name: Publish Extension to Visual Studio Marketplace
run-name: ${{ inputs.dry_run && 'ðŸ§ª Test publish workflow' || format('Validate, ðŸš€ Publish and Post-Process triggered from `{0}` branch', github.ref_name) }}

on:
  push:
    branches: [pipeline, main]
    paths-ignore: ['.github/workflows/**']
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in test mode (no actual publish)'
        type: boolean
        default: false

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.changes.outputs.should_publish }}
      version: ${{ steps.version.outputs.current }}
      skip_reason: ${{ steps.changes.outputs.skip_reason }}
      has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # For version diff check

      - name: Get version info
        id: version
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "âœ¨ Current version: $CURRENT"

      - name: Analyze changes
        id: changes
        run: |
          # Get the version change status
          VERSION_UPDATED=$(git diff HEAD^ HEAD -- package.json | grep -q '"version":' && echo "true" || echo "false")
          
          # Get code changes (excluding docs and configuration)
          CODE_CHANGES=$(git diff --name-only HEAD^ HEAD | \
            grep -vE '\.(md|txt)$|^docs/|^\.github/|^\.vscode/|package\.json$' || echo "")
          
          # Get documentation changes
          DOC_CHANGES=$(git diff --name-only HEAD^ HEAD | \
            grep -E '\.(md|txt)$|^docs/' || echo "")
          
          # Output change detection results
          echo "has_code_changes=${CODE_CHANGES:+true}" >> $GITHUB_OUTPUT
          echo "has_doc_changes=${DOC_CHANGES:+true}" >> $GITHUB_OUTPUT
          
          # Determine workflow action based on changes
          if [[ "$VERSION_UPDATED" == "true" ]]; then
            if [[ -n "$CODE_CHANGES" ]]; then
              # Version bump with code changes - proceed with publish
              echo "should_publish=true" >> $GITHUB_OUTPUT
              echo "skip_reason=" >> $GITHUB_OUTPUT
              echo "âœ… Publishing needed: Version update detected with code changes"
            else
              # Version bump without code changes - skip but warn
              echo "should_publish=false" >> $GITHUB_OUTPUT
              echo "skip_reason=Version update without code changes" >> $GITHUB_OUTPUT
              echo "âš ï¸ Version update detected but no code changes found"
            fi
          else
            if [[ -n "$CODE_CHANGES" ]]; then
              # Code changes without version bump - fail
              echo "should_publish=false" >> $GITHUB_OUTPUT
              echo "skip_reason=Code changes without version update" >> $GITHUB_OUTPUT
              echo "âŒ Code changes detected without version update"
              exit 1
            else
              # No relevant changes - skip
              echo "should_publish=false" >> $GITHUB_OUTPUT
              if [[ -n "$DOC_CHANGES" ]]; then
                echo "skip_reason=Documentation only changes" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ Documentation only changes detected"
              else
                echo "skip_reason=No significant changes" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ No significant changes detected"
              fi
            fi
          fi

  build-and-package:
    needs: validate
    if: needs.validate.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    outputs:
      vsix_path: ${{ steps.package.outputs.path }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install and build
        run: |
          npm ci
          npm run compile
          npm install -g @vscode/vsce
      
      - name: Package extension
        id: package
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VSIX_NAME="simple-coding-time-tracker-${VERSION}.vsix"
          
          rm -f *.vsix
          vsce package
          
          if [ ! -f "$VSIX_NAME" ]; then
            echo "::error::Failed to create VSIX package"
            exit 1
          fi
          
          echo "path=$VSIX_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Package created: $VSIX_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-v${{ needs.validate.outputs.version }}
          path: ${{ steps.package.outputs.path }}
          retention-days: 90

  publish:
    needs: [validate, build-and-package]
    runs-on: ubuntu-latest
    environment: VSC EXT
    outputs:
      status: ${{ steps.publish.outputs.status }}
      error_detail: ${{ steps.publish.outputs.error_detail }}
    steps:      
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: extension-v${{ needs.validate.outputs.version }}
      
      - name: Install vsce
        run: npm install -g @vscode/vsce
      
      - name: Publish to marketplace
        id: publish
        continue-on-error: true
        env:
          VSC_PAT: ${{ secrets.VSC_PAT }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "âœ¨ Dry run mode - simulating publish of v${VERSION}"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "This is a dry run - skipping actual publish" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Attempt to publish and capture output
          OUTPUT=$(vsce publish -p "$VSC_PAT" 2>&1)
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            # Check specific error cases
            if [[ "$OUTPUT" == *"already exists"* ]]; then
              echo "status=exists" >> $GITHUB_OUTPUT
            else
              echo "status=failed" >> $GITHUB_OUTPUT
              ERROR_DETAIL=$(echo "$OUTPUT" | grep -v "error" | tail -n 1)
              echo "error_detail=$ERROR_DETAIL" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Create and push Git tag
        if: steps.publish.outputs.status == 'success'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

  # Wrote this to update the run-name dynamically based on the publish status, but it is not supported in GitHub Actions now.
  # We can post the new extension publish in linked or comment on the PR.
  # https://github.com/orgs/community/discussions/69476
  post-process:
    needs: [validate, publish]
    if: always()
    runs-on: ubuntu-latest
    name: ${{ needs.validate.outputs.should_publish == 'false' 
      && format('{0} {1}', 
          needs.validate.outputs.has_code_changes == 'true' && 'âš ï¸' || 'â„¹ï¸',
          needs.validate.outputs.skip_reason) || needs.publish.result == 'success' 
      && needs.publish.outputs.status == 'success' 
      && format('âœ… Published v{0} successfully', needs.validate.outputs.version) || needs.publish.outputs.status == 'exists' 
      && format('â„¹ï¸ v{0} already exists', needs.validate.outputs.version) || format('âŒ Failed to publish v{0}', needs.validate.outputs.version) }}
    steps:
      - name: Set status summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Set step summary only
          if [[ "${{ needs.validate.outputs.should_publish }}" == "false" ]]; then
            if [[ "${{ needs.validate.outputs.has_code_changes }}" == "true" ]]; then
              echo "### âš ï¸ Version update needed for code changes" >> $GITHUB_STEP_SUMMARY
            else
              echo "### â„¹ï¸ Documentation update only" >> $GITHUB_STEP_SUMMARY
            fi
            echo "${{ needs.validate.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.publish.result }}" == "success" ]]; then
            case "${{ needs.publish.outputs.status }}" in
              "success")
                echo "### âœ… Published v${VERSION} successfully" >> $GITHUB_STEP_SUMMARY
                echo "Extension successfully published to VS Code Marketplace" >> $GITHUB_STEP_SUMMARY
                ;;
              "exists")
                echo "### â„¹ï¸ v${VERSION} already exists" >> $GITHUB_STEP_SUMMARY
                echo "Version already exists in VS Code Marketplace" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "### âŒ Failed to publish v${VERSION}" >> $GITHUB_STEP_SUMMARY
                echo "${{ needs.publish.outputs.error_detail }}" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          else
            echo "### âŒ Failed to publish v${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "Workflow failed during publish stage" >> $GITHUB_STEP_SUMMARY
          fi